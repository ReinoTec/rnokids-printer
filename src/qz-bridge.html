<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QZ Tray Bridge</title>
  <script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.5/qz-tray.js"></script>
</head>
<body>
  <h1 style="display:none;">QZ Tray Bridge</h1>
  
  <script>
    const { ipcRenderer } = require('electron')
    
    let qzConnected = false
    
    // Configurar assinatura via servidor
    qz.api.setSha256Type(data => {
      return ipcRenderer.invoke('qz-sign', data)
    })
    
    // Conectar ao QZ Tray
    async function connectQZ() {
      try {
        if (!qz.websocket.isActive()) {
          console.log('[QZ-BRIDGE] ðŸ”Œ Conectando ao QZ Tray...')
          await qz.websocket.connect()
          console.log('[QZ-BRIDGE] âœ… Conectado ao QZ Tray')
          qzConnected = true
          ipcRenderer.send('qz-connected', true)
        }
      } catch (error) {
        console.error('[QZ-BRIDGE] âŒ Erro ao conectar:', error)
        qzConnected = false
        ipcRenderer.send('qz-connected', false)
      }
    }
    
    // Imprimir via QZ Tray
    ipcRenderer.on('qz-print', async (event, { printerName, htmlCrianca, htmlResponsavel }) => {
      try {
        if (!qzConnected) {
          await connectQZ()
        }
        
        console.log('[QZ-BRIDGE] ðŸ–¨ï¸ Imprimindo...')
        console.log('[QZ-BRIDGE] ðŸ“ Impressora:', printerName)
        
        // ConfiguraÃ§Ã£o SIMPLES (igual versÃ£o web) - apenas nome da impressora
        const config = qz.configs.create(printerName)
        
        console.log('[QZ-BRIDGE] ðŸ“„ Config simples criado')
        
        // Imprimir etiqueta da crianÃ§a
        if (htmlCrianca) {
          console.log('[QZ-BRIDGE] ðŸ“„ Imprimindo etiqueta crianÃ§a...')
          const dataCrianca = [{
            type: 'html',
            format: 'plain',
            data: htmlCrianca
          }]
          await qz.print(config, dataCrianca)
          console.log('[QZ-BRIDGE] âœ… Etiqueta crianÃ§a impressa')
        }
        
        // Imprimir etiqueta do responsÃ¡vel
        if (htmlResponsavel) {
          console.log('[QZ-BRIDGE] ðŸ“„ Imprimindo etiqueta responsÃ¡vel...')
          const dataResponsavel = [{
            type: 'html',
            format: 'plain',
            data: htmlResponsavel
          }]
          await qz.print(config, dataResponsavel)
          console.log('[QZ-BRIDGE] âœ… Etiqueta responsÃ¡vel impressa')
        }
        
        ipcRenderer.send('qz-print-success')
      } catch (error) {
        console.error('[QZ-BRIDGE] âŒ Erro ao imprimir:', error)
        ipcRenderer.send('qz-print-error', error.message)
      }
    })
    
    // Conectar automaticamente ao carregar
    connectQZ()
    
    // Reconectar a cada 30 segundos se desconectar
    setInterval(() => {
      if (!qz.websocket.isActive()) {
        connectQZ()
      }
    }, 30000)
  </script>
</body>
</html>
