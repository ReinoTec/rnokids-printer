<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QZ Tray Bridge</title>
  <script src="https://cdn.jsdelivr.net/npm/qz-tray@2.2.5/qz-tray.js"></script>
</head>
<body>
  <h1 style="display:none;">QZ Tray Bridge</h1>
  
  <script>
    const { ipcRenderer } = require('electron')
    
    let qzConnected = false
    
    // Certificado do RNO Kids (comprado do QZ Tray)
    const QZ_CERTIFICATE = `-----BEGIN CERTIFICATE-----
MIIE0TCCArmgAwIBAgIQNzkyMDI1MTIxNTE2NDkxODANBgkqhkiG9w0BAQ0FADCB
mDELMAkGA1UEBhMCVVMxCzAJBgNVBAgMAk5ZMRswGQYDVQQKDBJRWiBJbmR1c3Ry
aWVzLCBMTEMxGzAZBgNVBAsMElFaIEluZHVzdHJpZXMsIExMQzEZMBcGA1UEAwwQ
cXppbmR1c3RyaWVzLmNvbTEnMCUGCSqGSIb3DQEJARYYc3VwcG9ydEBxemluZHVz
dHJpZXMuY29tMB4XDTI1MTIxNTE2NDkxOFoXDTI2MTIxNTE2NDYwNlowgYoxCzAJ
BgNVBAYMAkJSMQswCQYDVQQIDAJTQzEQMA4GA1UEBwwHSXRhamHDrTERMA8GA1UE
CgwIUmVpbm90ZWMxETAPBgNVBAsMCFJlaW5vdGVjMRAwDgYDVQQDDAdSbm9LaWRz
MSQwIgYJKoZIhvcNAQkBDBVjb250YXRvQHJub3RlYy5jb20uYnIwggEiMA0GCSqG
SIb3DQEBAQUAA4IBDwAwggEKAoIBAQCcnSlk/9F/B9vZIlsndMWOjDyzG35wrgpV
mfiyWBkNjhVaAfRtchYd6uhJz3DXXX5wNakRRx+Lg+IjsHMd4k0JacraZYclfkCS
D4W04HFcIrD8qKcG0M+Cm1E65CcpIdWZ0R764Cq2INX0pAr/G7G4i7DwEbvQ+rUE
O371XD2g6npc0l6T0zdZABUowjSlhTDBRB+ro4qgF2MQFhlU4Ad1eas6mbcmkza2
TOcPQozJmo6bLMXL2dDegnkP77SfxvnpOO8ZXBFPROX84r/FiUfwpAlTWVRXLv4p
V/EIYR1nDFtQMClsInvRMloosOdS8Ps5/mhW1z5YHNfT8FTssFNjAgMBAAGjIzAh
MB8GA1UdIwQYMBaAFJCmULeE1LnqX/IFhBN4ReipdVRcMA0GCSqGSIb3DQEBDQUA
A4ICAQB0rpEh2KtglvOgOoFWIYw4MLZFcEUmZqH4WG2JppIMTzao9RCv4aJd/4pZ
9q5k9KE8KXmJuJeA41oeZafA6dux3aOfQNsfSZe+qO59/fUMNAoQBI8wAaXmFGuJ
x7eIA801/7vEzKAA3Z6u+VfZBPE95+hx6JinLgUq8g5mbXm/X+TwMyY0gqR9hbAF
G12ILlwYxGtbvFrSYsfh3vjXx4QD8LpuLO5qoXcelIxQSkMJncDWhk6v2sIvxBby
nVRWjQgc25jPIKOVJ37K4OSv0wWLJRhcjaYKGhjxZkHULXR2S3shTFJI7gtoZlbq
7dnMFVL7t2vEvOt+JdhOeGq2GNvhLuyOQb05AqOnqXnS4UMbDtN01QFus5hQxr9P
3LkhEJfeDs2p7xxjQMnp9OdII4RbU6eTMpNAWQJK+/63vywOkBj1FyYR7FKZP2o7
VXf2othUyXq6vJ/+F+w1LLVBVpzzsOa/FVW9iHXSCbkjWqmqhLHQqCWzmOTx8L5n
KponBXOvnZYALq7GJ1MI3IPBTy+VqqR0vwCOLuhRYrgEPidwdI0gp4v8OdfWNGUW
D2r3aP/Yt8+Irisx5J2cg6oG/H+rZhMdQXbYF68t41oAqUvftHBQQmBYSp3nHajU
/5BCvpKnmM5ryA03zxr2Fxhkv1MOfcjwvf+w82YG/JNpNggBkw==
-----END CERTIFICATE-----
--START INTERMEDIATE CERT--
-----BEGIN CERTIFICATE-----
MIIFEjCCA/qgAwIBAgICEAAwDQYJKoZIhvcNAQELBQAwgawxCzAJBgNVBAYTAlVT
MQswCQYDVQQIDAJOWTESMBAGA1UEBwwJQ2FuYXN0b3RhMRswGQYDVQQKDBJRWiBJ
bmR1c3RyaWVzLCBMTEMxGzAZBgNVBAsMElFaIEluZHVzdHJpZXMsIExMQzEZMBcG
A1UEAwwQcXppbmR1c3RyaWVzLmNvbTEnMCUGCSqGSIb3DQEJARYYc3VwcG9ydEBx
emluZHVzdHJpZXMuY29tMB4XDTE1MDMwMjAwNTAxOFoXDTM1MDMwMjAwNTAxOFow
gZgxCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJOWTEbMBkGA1UECgwSUVogSW5kdXN0
cmllcywgTExDMRswGQYDVQQLDBJRWiBJbmR1c3RyaWVzLCBMTEMxGTAXBgNVBAMM
EHF6aW5kdXN0cmllcy5jb20xJzAlBgkqhkiG9w0BCQEWGHN1cHBvcnRAcXppbmR1
c3RyaWVzLmNvbTCCAiIwDQYJKoZIhvcNAQEBBQADggIPADCCAgoCggIBANTDgNLU
iohl/rQoZ2bTMHVEk1mA020LYhgfWjO0+GsLlbg5SvWVFWkv4ZgffuVRXLHrwz1H
YpMyo+Zh8ksJF9ssJWCwQGO5ciM6dmoryyB0VZHGY1blewdMuxieXP7Kr6XD3GRM
GAhEwTxjUzI3ksuRunX4IcnRXKYkg5pjs4nLEhXtIZWDLiXPUsyUAEq1U1qdL1AH
EtdK/L3zLATnhPB6ZiM+HzNG4aAPynSA38fpeeZ4R0tINMpFThwNgGUsxYKsP9kh
0gxGl8YHL6ZzC7BC8FXIB/0Wteng0+XLAVto56Pyxt7BdxtNVuVNNXgkCi9tMqVX
xOk3oIvODDt0UoQUZ/umUuoMuOLekYUpZVk4utCqXXlB4mVfS5/zWB6nVxFX8Io1
9FOiDLTwZVtBmzmeikzb6o1QLp9F2TAvlf8+DIGDOo0DpPQUtOUyLPCh5hBaDGFE
ZhE56qPCBiQIc4T2klWX/80C5NZnd/tJNxjyUyk7bjdDzhzT10CGRAsqxAnsjvMD
2KcMf3oXN4PNgyfpbfq2ipxJ1u777Gpbzyf0xoKwH9FYigmqfRH2N2pEdiYawKrX
6pyXzGM4cvQ5X1Yxf2x/+xdTLdVaLnZgwrdqwFYmDejGAldXlYDl3jbBHVM1v+uY
5ItGTjk+3vLrxmvGy5XFVG+8fF/xaVfo5TW5AgMBAAGjUDBOMB0GA1UdDgQWBBSQ
plC3hNS56l/yBYQTeEXoqXVUXDAfBgNVHSMEGDAWgBQDRcZNwPqOqQvagw9BpW0S
BkOpXjAMBgNVHRMEBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQAJIO8SiNr9jpLQ
eUsFUmbueoxyI5L+P5eV92ceVOJ2tAlBA13vzF1NWlpSlrMmQcVUE/K4D01qtr0k
gDs6LUHvj2XXLpyEogitbBgipkQpwCTJVfC9bWYBwEotC7Y8mVjjEV7uXAT71GKT
x8XlB9maf+BTZGgyoulA5pTYJ++7s/xX9gzSWCa+eXGcjguBtYYXaAjjAqFGRAvu
pz1yrDWcA6H94HeErJKUXBakS0Jm/V33JDuVXY+aZ8EQi2kV82aZbNdXll/R6iGw
2ur4rDErnHsiphBgZB71C5FD4cdfSONTsYxmPmyUb5T+KLUouxZ9B0Wh28ucc1Lp
rbO7BnjW
-----END CERTIFICATE-----`;
    
    // Configurar certificado para QZ Tray (OBRIGATÃ“RIO para certificados comprados)
    qz.security.setCertificatePromise(function(resolve, reject) {
      resolve(QZ_CERTIFICATE);
    });
    
    // Configurar algoritmo de assinatura SHA512 (OBRIGATÃ“RIO desde QZ 2.1)
    qz.security.setSignatureAlgorithm("SHA512");
    
    // Configurar assinatura LOCAL (usa a chave privada comprada)
    qz.security.setSignaturePromise(function(toSign) {
      return function(resolve, reject) {
        ipcRenderer.invoke('qz-sign', toSign)
          .then(signature => resolve(signature))
          .catch(err => reject(err));
      };
    });
    
    // Conectar ao QZ Tray
    async function connectQZ() {
      try {
        if (!qz.websocket.isActive()) {
          console.log('[QZ-BRIDGE] ðŸ”Œ Conectando ao QZ Tray...')
          await qz.websocket.connect()
          console.log('[QZ-BRIDGE] âœ… Conectado ao QZ Tray')
          qzConnected = true
          ipcRenderer.send('qz-connected', true)
        }
      } catch (error) {
        console.error('[QZ-BRIDGE] âŒ Erro ao conectar:', error)
        qzConnected = false
        ipcRenderer.send('qz-connected', false)
      }
    }
    
    // Imprimir via QZ Tray
    ipcRenderer.on('qz-print', async (event, { printerName, htmlCrianca, htmlResponsavel }) => {
      try {
        if (!qzConnected) {
          await connectQZ()
        }
        
        console.log('[QZ-BRIDGE] ðŸ–¨ï¸ Imprimindo...')
        console.log('[QZ-BRIDGE] ðŸ“ Impressora:', printerName)
        
        // ConfiguraÃ§Ã£o SIMPLES (igual versÃ£o web) - apenas nome da impressora
        const config = qz.configs.create(printerName)
        
        console.log('[QZ-BRIDGE] ðŸ“„ Config simples criado')
        
        // Imprimir etiqueta da crianÃ§a
        if (htmlCrianca) {
          console.log('[QZ-BRIDGE] ðŸ“„ Imprimindo etiqueta crianÃ§a...')
          const dataCrianca = [{
            type: 'html',
            format: 'plain',
            data: htmlCrianca
          }]
          await qz.print(config, dataCrianca)
          console.log('[QZ-BRIDGE] âœ… Etiqueta crianÃ§a impressa')
        }
        
        // Imprimir etiqueta do responsÃ¡vel
        if (htmlResponsavel) {
          console.log('[QZ-BRIDGE] ðŸ“„ Imprimindo etiqueta responsÃ¡vel...')
          const dataResponsavel = [{
            type: 'html',
            format: 'plain',
            data: htmlResponsavel
          }]
          await qz.print(config, dataResponsavel)
          console.log('[QZ-BRIDGE] âœ… Etiqueta responsÃ¡vel impressa')
        }
        
        ipcRenderer.send('qz-print-success')
      } catch (error) {
        console.error('[QZ-BRIDGE] âŒ Erro ao imprimir:', error)
        ipcRenderer.send('qz-print-error', error.message)
      }
    })
    
    // Conectar automaticamente ao carregar
    connectQZ()
    
    // Reconectar a cada 30 segundos se desconectar
    setInterval(() => {
      if (!qz.websocket.isActive()) {
        connectQZ()
      }
    }, 30000)
  </script>
</body>
</html>
